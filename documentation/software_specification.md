# 游늶 Especificaci칩n de Software - Calculadora de Retenci칩n SUNAT 5ta Categor칤a

## 1. Descripci칩n General

### 1.1 Prop칩sito
Desarrollar un software para la SUNAT que permita calcular el porcentaje de retenci칩n de los trabajadores de quinta categor칤a para el ejercicio actual, considerando ingresos mensuales, gratificaciones, bonificaciones, utilidades y otros adicionales, con soporte completo para multi-empleador y cambios de trabajo durante el a침o.

### 1.2 Alcance
- C치lculo de retenciones mensuales de renta de 5ta categor칤a
- Proyecci칩n anual de impuestos con soporte para ingreso en cualquier mes
- Manejo de trabajadores con m칰ltiples empleadores simult치neos
- Carga y consolidaci칩n de retenciones previas certificadas
- C치lculo de retenciones considerando adicionales variables con pol칤ticas espec칤ficas
- Generaci칩n de reportes mensuales detallados con trazabilidad completa
- Soporte para cese de trabajo con liquidaci칩n final

### 1.3 Usuarios Objetivo
- Personal de recursos humanos
- Contadores y asesores tributarios
- Personal de la SUNAT
- Empresas que requieran calcular retenciones de 5ta categor칤a
- Auditores internos y externos

---

## 2. Requisitos Funcionales

### 2.1 Gesti칩n de Trabajadores
- **RF-001**: Registrar trabajador con datos b치sicos (nombre, DNI, fecha de ingreso)
- **RF-002**: Permitir ingreso de trabajador en cualquier mes del a침o
- **RF-003**: Editar informaci칩n del trabajador
- **RF-004**: Eliminar trabajador del sistema
- **RF-005**: Registrar cese de trabajo con fecha y motivo
- **RF-006**: Gestionar m칰ltiples empleadores simult치neos

### 2.2 Gesti칩n de Empleadores
- **RF-007**: Registrar empleadores con datos fiscales
- **RF-008**: Designar empleador principal para retenciones
- **RF-009**: Cargar constancias de retenciones de otros empleadores
- **RF-010**: Consolidar retenciones previas certificadas

### 2.3 Configuraci칩n del Ejercicio
- **RF-011**: Configurar a침o fiscal
- **RF-012**: Configurar valor de UIT del a침o
- **RF-013**: Configurar tasas de impuestos por tramos con vigencia
- **RF-014**: Configurar pol칤tica de redondeo (2 decimales, half-up)
- **RF-015**: Gestionar cambios de tasas intra-a침o

### 2.4 Gesti칩n de Ingresos
- **RF-016**: Ingresar remuneraci칩n mensual base
- **RF-017**: Registrar gratificaciones legales (julio/diciembre)
- **RF-018**: Registrar bonificaciones extraordinarias
- **RF-019**: Registrar utilidades con reglas espec칤ficas
- **RF-020**: Registrar otros adicionales (comisiones, horas extras, etc.)
- **RF-021**: Clasificar tipo de adicional y pol칤tica de proyecci칩n
- **RF-022**: Modificar ingresos de meses anteriores con auditor칤a

### 2.5 C치lculos de Retenci칩n
- **RF-023**: Calcular proyecci칩n anual de ingresos (considerando mes de ingreso)
- **RF-024**: Aplicar deducci칩n de 7 UIT
- **RF-025**: Calcular renta neta proyectada
- **RF-026**: Aplicar escala progresiva acumulativa versionada
- **RF-027**: Calcular impuesto anual proyectado
- **RF-028**: Calcular retenciones mensuales (m칠todo proporcional enero-marzo, m칠todo saldo abril-diciembre)
- **RF-029**: Recalcular retenciones cuando se modifican ingresos o adicionales
- **RF-030**: Manejar liquidaci칩n final en caso de cese

### 2.6 Reportes y Visualizaci칩n
- **RF-031**: Mostrar tabla mensual de c치lculos con trazabilidad
- **RF-032**: Generar constancia mensual por trabajador
- **RF-033**: Generar reporte de retenciones por mes
- **RF-034**: Mostrar resumen anual con auditor칤a
- **RF-035**: Exportar reportes en formato PDF/Excel/CSV
- **RF-036**: Generar reporte de auditor칤a de cambios

---

## 3. Requisitos No Funcionales

### 3.1 Rendimiento
- **RNF-001**: El sistema debe responder en menos de 2 segundos para c치lculos de un trabajador
- **RNF-002**: Soporte para hasta 1000 trabajadores simult치neos
- **RNF-003**: C치lculos en tiempo real sin recarga de p치gina
- **RNF-004**: Re-proyecci칩n mensual en menos de 1 segundo

### 3.2 Usabilidad
- **RNF-005**: Interfaz intuitiva y f치cil de usar
- **RNF-006**: Formularios con validaci칩n en tiempo real
- **RNF-007**: Mensajes de error claros y espec칤ficos
- **RNF-008**: Dise침o responsive para diferentes dispositivos
- **RNF-009**: Wizards para flujos complejos (multi-empleador, cese)

### 3.3 Seguridad y Privacidad
- **RNF-010**: Autenticaci칩n de usuarios con MFA
- **RNF-011**: Control de acceso basado en roles (RRHH, Auditor, Admin)
- **RNF-012**: Auditor칤a completa de cambios en c치lculos
- **RNF-013**: Cifrado en reposo para datos PII (DNI, nombre)
- **RNF-014**: TLS 1.3 en tr치nsito
- **RNF-015**: Retenci칩n de logs conforme a pol칤tica (5 a침os)
- **RNF-016**: Backup autom치tico de datos con cifrado

### 3.4 Compatibilidad
- **RNF-017**: Compatible con navegadores modernos (Chrome, Firefox, Safari, Edge)
- **RNF-018**: Funcionamiento en dispositivos m칩viles
- **RNF-019**: Compatible con Vercel deployment
- **RNF-020**: Soporte para importaci칩n de constancias SUNAT

---

## 4. Arquitectura del Sistema

### 4.1 Tecnolog칤as Recomendadas
- **Frontend**: Next.js 14 con TypeScript
- **Backend**: API Routes de Next.js
- **Base de Datos**: PostgreSQL con Prisma ORM
- **Deployment**: Vercel
- **UI Framework**: Tailwind CSS + Headless UI
- **Validaci칩n**: Zod
- **Testing**: Jest + Testing Library
- **Cifrado**: bcrypt para hashes, AES-256 para datos sensibles

### 4.2 Estructura de Base de Datos

```sql
-- Tabla de trabajadores
CREATE TABLE workers (
  id SERIAL PRIMARY KEY,
  dni VARCHAR(8) UNIQUE NOT NULL,
  name VARCHAR(255) NOT NULL,
  start_date DATE NOT NULL,
  start_month INTEGER NOT NULL CHECK (start_month >= 1 AND start_month <= 12),
  end_date DATE NULL, -- Para cese
  end_reason VARCHAR(255) NULL,
  status VARCHAR(20) NOT NULL DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'terminated')),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabla de empleadores
CREATE TABLE employers (
  id SERIAL PRIMARY KEY,
  ruc VARCHAR(11) UNIQUE NOT NULL,
  business_name VARCHAR(255) NOT NULL,
  tax_address TEXT NOT NULL,
  is_primary BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Tabla de contratos de empleo
CREATE TABLE employment_contracts (
  id SERIAL PRIMARY KEY,
  worker_id INTEGER REFERENCES workers(id) ON DELETE CASCADE,
  employer_id INTEGER REFERENCES employers(id) ON DELETE CASCADE,
  start_date DATE NOT NULL,
  end_date DATE NULL,
  is_primary BOOLEAN NOT NULL DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(worker_id, employer_id, start_date)
);

-- Tabla de configuraci칩n anual
CREATE TABLE yearly_config (
  id SERIAL PRIMARY KEY,
  year INTEGER NOT NULL,
  uit_value DECIMAL(10,2) NOT NULL,
  deduction_7uit DECIMAL(10,2) NOT NULL,
  rounding_policy VARCHAR(20) NOT NULL DEFAULT 'half-up',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(year)
);

-- Tabla de tramos fiscales por vigencia
CREATE TABLE tax_tiers (
  id SERIAL PRIMARY KEY,
  year INTEGER NOT NULL,
  tier_order INTEGER NOT NULL,
  min_uit DECIMAL(8,2) NOT NULL,
  max_uit DECIMAL(8,2) NULL, -- NULL para 칰ltimo tramo
  min_amount DECIMAL(12,2) NOT NULL,
  max_amount DECIMAL(12,2) NULL,
  rate_pct DECIMAL(5,2) NOT NULL,
  effective_from DATE NOT NULL,
  effective_to DATE NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(year, tier_order, effective_from)
);

-- Tabla de ingresos mensuales
CREATE TABLE monthly_income (
  id SERIAL PRIMARY KEY,
  worker_id INTEGER REFERENCES workers(id) ON DELETE CASCADE,
  employer_id INTEGER REFERENCES employers(id) ON DELETE CASCADE,
  year INTEGER NOT NULL,
  month INTEGER NOT NULL CHECK (month >= 1 AND month <= 12),
  base_salary DECIMAL(10,2) NOT NULL DEFAULT 0,
  gratuity DECIMAL(10,2) NOT NULL DEFAULT 0,
  bonus DECIMAL(10,2) NOT NULL DEFAULT 0,
  utilities DECIMAL(10,2) NOT NULL DEFAULT 0,
  other_additional DECIMAL(10,2) NOT NULL DEFAULT 0,
  income_source_type VARCHAR(50) NOT NULL DEFAULT 'regular', -- 'regular', 'gratuity', 'bonus', 'utilities', 'other'
  projection_policy VARCHAR(20) NOT NULL DEFAULT 'monthly', -- 'monthly', 'prorated', 'annual'
  notes TEXT NULL,
  total_income DECIMAL(10,2) GENERATED ALWAYS AS (
    base_salary + gratuity + bonus + utilities + other_additional
  ) STORED,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(worker_id, employer_id, year, month)
);

-- Tabla de retenciones previas certificadas
CREATE TABLE prior_withholdings (
  id SERIAL PRIMARY KEY,
  worker_id INTEGER REFERENCES workers(id) ON DELETE CASCADE,
  employer_id INTEGER REFERENCES employers(id) ON DELETE CASCADE,
  year INTEGER NOT NULL,
  month INTEGER NOT NULL CHECK (month >= 1 AND month <= 12),
  amount DECIMAL(10,2) NOT NULL,
  certificate_number VARCHAR(50) NOT NULL,
  certificate_date DATE NOT NULL,
  source_employer VARCHAR(255) NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(worker_id, employer_id, year, month)
);

-- Tabla de retenciones calculadas
CREATE TABLE monthly_retention (
  id SERIAL PRIMARY KEY,
  worker_id INTEGER REFERENCES workers(id) ON DELETE CASCADE,
  employer_id INTEGER REFERENCES employers(id) ON DELETE CASCADE,
  year INTEGER NOT NULL,
  month INTEGER NOT NULL CHECK (month >= 1 AND month <= 12),
  projected_annual_income DECIMAL(12,2) NOT NULL,
  projected_net_income DECIMAL(12,2) NOT NULL,
  projected_tax DECIMAL(12,2) NOT NULL,
  expected_accumulated_retention DECIMAL(12,2) NOT NULL,
  previous_accumulated_retention DECIMAL(12,2) NOT NULL DEFAULT 0,
  monthly_retention DECIMAL(10,2) NOT NULL,
  calculation_method VARCHAR(20) NOT NULL, -- 'proportional' o 'balance'
  calculation_hash VARCHAR(64) NOT NULL, -- Para no repudio
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(worker_id, employer_id, year, month)
);

-- Tabla de logs de c치lculo
CREATE TABLE calculation_logs (
  id SERIAL PRIMARY KEY,
  worker_id INTEGER REFERENCES workers(id) ON DELETE CASCADE,
  employer_id INTEGER REFERENCES employers(id) ON DELETE CASCADE,
  year INTEGER NOT NULL,
  month INTEGER NOT NULL,
  calculation_type VARCHAR(50) NOT NULL, -- 'initial', 'recalculation', 'adjustment'
  inputs JSONB NOT NULL, -- Datos de entrada
  formula_version VARCHAR(20) NOT NULL, -- Versi칩n de la f칩rmula aplicada
  calculation_hash VARCHAR(64) NOT NULL, -- Hash del resultado
  user_id INTEGER NULL, -- Usuario que realiz칩 el c치lculo
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Triggers para updated_at
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_workers_updated_at BEFORE UPDATE ON workers FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_monthly_income_updated_at BEFORE UPDATE ON monthly_income FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
CREATE TRIGGER update_monthly_retention_updated_at BEFORE UPDATE ON monthly_retention FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

-- 칈ndices para optimizaci칩n
CREATE INDEX idx_monthly_income_worker_year_month ON monthly_income(worker_id, year, month);
CREATE INDEX idx_monthly_retention_worker_year_month ON monthly_retention(worker_id, year, month);
CREATE INDEX idx_tax_tiers_year_effective ON tax_tiers(year, effective_from);
CREATE INDEX idx_calculation_logs_worker_year_month ON calculation_logs(worker_id, year, month);
```

---

## 5. Especificaci칩n de Funcionalidades

### 5.1 Flujo Principal de C치lculo (CORREGIDO)

```typescript
interface RetentionCalculation {
  workerId: number;
  employerId: number;
  year: number;
  month: number;
  baseSalary: number;
  additionalIncome: number;
  previousRetentions: number;
  priorWithholdings: number; // Retenciones certificadas de otros empleadores
  startMonth: number; // Mes de ingreso del trabajador
}

interface CalculationResult {
  projectedAnnualIncome: number;
  projectedNetIncome: number;
  projectedTax: number;
  expectedAccumulatedRetention: number;
  monthlyRetention: number;
  calculationMethod: 'proportional' | 'balance';
  calculationHash: string;
}

// Funci칩n de redondeo consistente (2 decimales, half-up)
function round2(value: number): number {
  return Math.round(value * 100) / 100;
}

function calculateRetention(input: RetentionCalculation): CalculationResult {
  // 1. Proyecci칩n anual considerando mes de ingreso
  const projectedAnnualIncome = calculateProjectedAnnualIncome(input);
  
  // 2. Renta neta proyectada
  const projectedNetIncome = Math.max(0, projectedAnnualIncome - DEDUCTION_7UIT);
  
  // 3. Impuesto proyectado por tramos
  const projectedTax = calculateTaxByTiers(projectedNetIncome);
  
  // 4. Consolidar retenciones previas (propias + certificadas)
  const totalPreviousRetentions = input.previousRetentions + input.priorWithholdings;
  
  let calculationMethod: 'proportional' | 'balance';
  let monthlyRetention: number;
  let expectedAccumulatedRetention: number;

  if (input.month <= 3) {
    // M칠todo proporcional (enero a marzo): objetivo acumulado y diferencia
    const targetAccumulated = projectedTax * (input.month / 12);
    monthlyRetention = Math.max(0, round2(targetAccumulated - totalPreviousRetentions));
    expectedAccumulatedRetention = round2(totalPreviousRetentions + monthlyRetention);
    calculationMethod = 'proportional';
  } else {
    // M칠todo saldo (abril a diciembre): monto mensual directo
    const remainingMonths = 13 - input.month; // abril=9, mayo=8, ..., dic=1
    const remainingTax = Math.max(0, projectedTax - totalPreviousRetentions);
    monthlyRetention = round2(remainingTax / remainingMonths);
    expectedAccumulatedRetention = round2(totalPreviousRetentions + monthlyRetention);
    calculationMethod = 'balance';
  }

  // 5. Generar hash de c치lculo para trazabilidad
  const calculationHash = generateCalculationHash({
    inputs: input,
    projectedTax,
    monthlyRetention,
    calculationMethod
  });

  return {
    projectedAnnualIncome,
    projectedNetIncome,
    projectedTax,
    expectedAccumulatedRetention,
    monthlyRetention,
    calculationMethod,
    calculationHash
  };
}

// Funci칩n para proyecci칩n anual considerando mes de ingreso
function calculateProjectedAnnualIncome(input: RetentionCalculation): number {
  const monthsRemaining = 13 - input.startMonth;
  
  // Opci칩n A (conservadora): proyectar solo meses restantes
  const baseProjection = input.baseSalary * monthsRemaining;
  
  // Sumar adicionales futuros seg칰n pol칤tica
  const additionalProjection = calculateAdditionalProjection(input);
  
  return round2(baseProjection + additionalProjection);
}

// Funci칩n para proyecci칩n de adicionales seg칰n pol칤tica
function calculateAdditionalProjection(input: RetentionCalculation): number {
  // Implementar seg칰n pol칤ticas espec칤ficas de cada tipo de adicional
  // Gratificaciones legales: prorratear en meses restantes
  // Bonos extraordinarios: seg칰n pol칤tica de empresa
  // Utilidades: reglas espec칤ficas SUNAT
  return 0; // Placeholder
}
```

### 5.2 C치lculo de Impuesto por Tramos (Versionado)

```typescript
interface TaxTier {
  id: number;
  year: number;
  tierOrder: number;
  minUIT: number;
  maxUIT: number | null;
  minAmount: number;
  maxAmount: number | null;
  ratePct: number;
  effectiveFrom: Date;
  effectiveTo: Date | null;
}

function calculateTaxByTiers(netIncome: number, year: number, calculationDate: Date): number {
  // Obtener tramos vigentes para la fecha de c치lculo
  const activeTiers = getActiveTaxTiers(year, calculationDate);
  
  let totalTax = 0;
  let remainingIncome = netIncome;
  
  for (const tier of activeTiers) {
    if (remainingIncome <= 0) break;
    
    const tierAmount = Math.min(
      remainingIncome,
      (tier.maxAmount || Infinity) - tier.minAmount
    );
    
    if (tierAmount > 0) {
      totalTax += tierAmount * (tier.ratePct / 100);
      remainingIncome -= tierAmount;
    }
  }
  
  return round2(totalTax); // Redondeo consistente a 2 decimales
}

function getActiveTaxTiers(year: number, date: Date): TaxTier[] {
  // Consultar base de datos para tramos vigentes en la fecha
  return prisma.taxTiers.findMany({
    where: {
      year,
      effectiveFrom: { lte: date },
      OR: [
        { effectiveTo: null },
        { effectiveTo: { gte: date } }
      ]
    },
    orderBy: { tierOrder: 'asc' }
  });
}
```

### 5.3 Manejo de Multi-Empleador

```typescript
interface MultiEmployerCalculation {
  workerId: number;
  year: number;
  month: number;
  primaryEmployerId: number;
  secondaryEmployers: SecondaryEmployer[];
}

interface SecondaryEmployer {
  employerId: number;
  withholdings: PriorWithholding[];
}

function calculateMultiEmployerRetention(input: MultiEmployerCalculation): CalculationResult {
  // 1. Obtener retenciones del empleador principal
  const primaryRetention = getPrimaryEmployerRetention(input);
  
  // 2. Consolidar retenciones certificadas de otros empleadores
  const certifiedWithholdings = consolidateCertifiedWithholdings(input.secondaryEmployers);
  
  // 3. Calcular retenci칩n considerando consolidaci칩n
  return calculateRetention({
    ...input,
    previousRetentions: primaryRetention.previousRetentions,
    priorWithholdings: certifiedWithholdings.totalAmount
  });
}

function consolidateCertifiedWithholdings(secondaryEmployers: SecondaryEmployer[]): {
  totalAmount: number;
  details: PriorWithholding[];
} {
  let totalAmount = 0;
  const details: PriorWithholding[] = [];
  
  for (const employer of secondaryEmployers) {
    for (const withholding of employer.withholdings) {
      totalAmount += withholding.amount;
      details.push(withholding);
    }
  }
  
  return {
    totalAmount: round2(totalAmount),
    details
  };
}
```

---

## 6. Interfaz de Usuario

### 6.1 P치ginas Principales

#### 6.1.1 Dashboard Principal
- Resumen de trabajadores activos por empleador
- Total de retenciones del mes actual consolidado
- Gr치ficos de retenciones por mes con filtros por empleador
- Alertas de cambios en ingresos o adicionales
- Acceso r치pido a funcionalidades principales

#### 6.1.2 Gesti칩n de Trabajadores
- Lista de trabajadores con b칰squeda y filtros por empleador
- Formulario de registro/edici칩n con validaciones
- Vista detallada de cada trabajador con historial
- Gesti칩n de cese con liquidaci칩n final
- Importaci칩n de constancias de empleador anterior

#### 6.1.3 Gesti칩n de Empleadores
- Lista de empleadores con datos fiscales
- Designaci칩n de empleador principal
- Carga de constancias de retenciones certificadas
- Validaci칩n de RUC y datos fiscales

#### 6.1.4 Calculadora de Retenci칩n
- Formulario de entrada de datos con validaci칩n en tiempo real
- Vista previa de c치lculos con trazabilidad completa
- Tabla mensual de resultados con m칠todo de c치lculo
- Botones de acci칩n (guardar, exportar, imprimir, auditor칤a)
- Wizards para flujos complejos (multi-empleador, cese)

#### 6.1.5 Configuraci칩n del Sistema
- Configuraci칩n anual (UIT, tasas por vigencia)
- Configuraci칩n de empresa y empleadores
- Gesti칩n de usuarios y permisos con RBAC
- Pol칤ticas de redondeo y c치lculo

### 6.2 Componentes de UI

#### 6.2.1 Formulario de Trabajador
```typescript
interface WorkerForm {
  dni: string;
  name: string;
  startDate: Date;
  startMonth: number;
  baseSalary: number;
  primaryEmployerId: number;
  secondaryEmployerIds: number[];
}
```

#### 6.2.2 Formulario de Ingresos Mensuales
```typescript
interface MonthlyIncomeForm {
  year: number;
  month: number;
  baseSalary: number;
  gratuity: number;
  bonus: number;
  utilities: number;
  otherAdditional: number;
  incomeSourceType: 'regular' | 'gratuity' | 'bonus' | 'utilities' | 'other';
  projectionPolicy: 'monthly' | 'prorated' | 'annual';
  notes: string;
}
```

#### 6.2.3 Formulario de Multi-Empleador
```typescript
interface MultiEmployerForm {
  primaryEmployerId: number;
  secondaryEmployers: {
    employerId: number;
    certificateFile: File;
    certificateNumber: string;
    certificateDate: Date;
  }[];
}
```

#### 6.2.4 Tabla de Resultados
- Columnas: Mes, Ingreso, Adicionales, Proyecci칩n Anual, Renta Neta, Impuesto, Retenci칩n Acumulada, Retenci칩n del Mes, M칠todo, Hash
- Filtros por a침o, trabajador y empleador
- Exportaci칩n a Excel/PDF/CSV
- Auditor칤a de cambios con historial

---

## 7. Casos de Uso

### 7.1 Caso de Uso: Calcular Retenci칩n de Nuevo Trabajador
1. Usuario accede al sistema
2. Registra nuevo trabajador con fecha de ingreso y empleador principal
3. Ingresa remuneraci칩n mensual base
4. Sistema calcula proyecci칩n anual (considerando mes de ingreso)
5. Sistema aplica deducci칩n de 7 UIT
6. Sistema calcula impuesto por tramos vigentes
7. Sistema calcula retenciones mensuales seg칰n m칠todo
8. Usuario visualiza resultados en tabla mensual con trazabilidad
9. Usuario puede exportar constancia mensual o imprimir reporte

### 7.2 Caso de Uso: Multi-Empleador con Retenciones Certificadas
1. Usuario registra trabajador con m칰ltiples empleadores
2. Designa empleador principal para retenciones
3. Carga constancias de retenciones de otros empleadores
4. Sistema valida constancias y consolida montos
5. Sistema recalcula retenciones considerando consolidaci칩n
6. Usuario visualiza retenciones consolidadas por mes
7. Sistema genera constancia consolidada para SUNAT

### 7.3 Caso de Uso: Modificar Ingresos y Recalcular
1. Usuario modifica ingresos de un mes espec칤fico
2. Sistema valida que solo se modifiquen meses anteriores
3. Sistema recalcula proyecci칩n anual
4. Sistema recalcula impuesto proyectado
5. Sistema recalcula retenciones desde el mes de modificaci칩n
6. Sistema actualiza tabla de resultados con nueva trazabilidad
7. Sistema registra log de auditor칤a del cambio
8. Usuario confirma cambios

### 7.4 Caso de Uso: Cese de Trabajador con Liquidaci칩n Final
1. Usuario registra cese de trabajador con fecha y motivo
2. Sistema calcula liquidaci칩n final del mes de cese
3. Sistema ajusta proyecci칩n anual a meses trabajados
4. Sistema recalcula retenciones finales
5. Sistema genera constancia de liquidaci칩n final
6. Usuario puede exportar constancia para declaraci칩n anual

### 7.5 Caso de Uso: Configurar Ejercicio Fiscal
1. Administrador accede a configuraci칩n
2. Ingresa nuevo valor de UIT
3. Configura tasas por tramos con fechas de vigencia
4. Sistema valida datos y consistencia
5. Sistema actualiza configuraci칩n
6. Sistema recalcula todas las retenciones activas
7. Sistema genera reporte de impacto de cambios

---

## 8. Validaciones y Reglas de Negocio

### 8.1 Validaciones de Entrada
- DNI debe tener 8 d칤gitos num칠ricos 칰nicos
- Fecha de ingreso no puede ser futura
- Mes de ingreso debe estar entre 1 y 12
- Ingresos no pueden ser negativos
- UIT debe ser mayor a 0
- RUC debe tener 11 d칤gitos y ser v치lido
- Fechas de vigencia de tasas no pueden solaparse

### 8.2 Reglas de Negocio
- Solo se pueden modificar ingresos de meses anteriores
- Las retenciones se calculan desde el mes de ingreso
- Los adicionales se consideran seg칰n pol칤tica espec칤fica
- El m칠todo de c치lculo cambia seg칰n el mes (proporcional vs saldo)
- Las retenciones no pueden ser negativas
- Un trabajador solo puede tener un empleador principal por a침o
- Las constancias de retenciones previas deben ser v치lidas y vigentes
- En caso de cese, se liquida solo hasta el mes trabajado

### 8.3 Manejo de Errores
- Validaci칩n en tiempo real en formularios
- Mensajes de error espec칤ficos por campo
- Log de errores para auditor칤a con contexto completo
- Rollback autom치tico en caso de fallo en c치lculos
- Notificaciones de errores cr칤ticos a administradores

---

## 9. Testing

### 9.1 Casos de Prueba Obligatorios

#### 9.1.1 Casos Base de SUNAT
- C치lculos con los casos proporcionados en `casos_de_prueba.md`
- Validaci칩n de f칩rmulas seg칰n `plantilla-formulas-sunat-5ta.md`
- Verificaci칩n de redondeo consistente (2 decimales, half-up)

#### 9.1.2 Casos de Multi-Empleador
- Trabajador con 2 empleadores simult치neos
- Consolidaci칩n de retenciones certificadas
- Cambio de empleador principal durante el a침o
- Validaci칩n de constancias de otros empleadores

#### 9.1.3 Casos de Ingreso/Cese
- Ingreso en septiembre (4 meses restantes)
- Cese en noviembre con liquidaci칩n final
- Distribuci칩n correcta de retenciones en meses restantes
- Validaci칩n de cierre exacto (suma = impuesto proyectado 췀 0.01)

#### 9.1.4 Casos de Adicionales
- Gratificaciones legales (julio/diciembre)
- Bonos extraordinarios con pol칤ticas espec칤ficas
- Utilidades con reglas SUNAT
- Re-proyecci칩n mensual al a침adir adicionales

#### 9.1.5 Casos de Edge Cases
- Ingresos muy altos (m치ximo tramo)
- Ingresos muy bajos (sin retenci칩n)
- Cambios de sueldo m칰ltiples en el a침o
- Tasas de impuesto cambiantes intra-a침o

### 9.2 Tipos de Testing
- **Unit testing**: Funciones de c치lculo individuales
- **Integration testing**: Flujos completos de c치lculo
- **E2E testing**: Casos de uso principales
- **Performance testing**: 1000 trabajadores con cambios simult치neos
- **Security testing**: Validaci칩n de acceso y cifrado
- **Compliance testing**: Verificaci칩n de f칩rmulas SUNAT

### 9.3 M칠tricas de Testing
- Cobertura de c칩digo: m칤nimo 90%
- Tiempo de respuesta: m치ximo 2 segundos
- Precisi칩n de c치lculos: error m치ximo 췀0.01
- Rendimiento: 1000 trabajadores en <30 segundos

---

## 10. Despliegue y Mantenimiento

### 10.1 Despliegue
- Deployment autom치tico en Vercel con CI/CD
- Variables de entorno para configuraci칩n sensible
- Base de datos PostgreSQL en Vercel con cifrado
- CDN para assets est치ticos con cache optimizado
- Health checks autom치ticos

### 10.2 Monitoreo
- Logs de aplicaci칩n con niveles estructurados
- M칠tricas de rendimiento en tiempo real
- Alertas de errores con escalado autom치tico
- Dashboard de monitoreo con KPIs clave
- Backup autom치tico de base de datos con cifrado

### 10.3 Actualizaciones
- Actualizaci칩n anual de UIT y tasas con migraci칩n autom치tica
- Migraciones de base de datos con rollback autom치tico
- Deployment sin tiempo de inactividad (blue-green)
- Actualizaci칩n de f칩rmulas con versionado
- Notificaciones de cambios a usuarios

---

## 11. Cronograma de Desarrollo

### Fase 1 (Semanas 1-2): Setup y Arquitectura
- Configuraci칩n del proyecto Next.js con TypeScript
- Configuraci칩n de Prisma y base de datos PostgreSQL
- Estructura de carpetas y componentes base
- Configuraci칩n de seguridad y cifrado

### Fase 2 (Semanas 3-4): Funcionalidades Core
- Implementaci칩n de c치lculos de retenci칩n corregidos
- API endpoints b치sicos con validaci칩n
- Componentes de formulario con validaci칩n en tiempo real
- Sistema de auditor칤a y logs

### Fase 3 (Semanas 5-6): Multi-Empleador y Cese
- Gesti칩n de m칰ltiples empleadores
- Carga de constancias certificadas
- Consolidaci칩n de retenciones previas
- Manejo de cese con liquidaci칩n final

### Fase 4 (Semanas 7-8): UI y UX
- Interfaz de usuario completa con wizards
- Tablas de resultados con trazabilidad
- Reportes y exportaci칩n m칰ltiple
- Dashboard y visualizaciones

### Fase 5 (Semanas 9-10): Testing y Refinamiento
- Implementaci칩n de casos de prueba completos
- Testing de rendimiento y seguridad
- Optimizaciones y refinamientos
- Documentaci칩n de usuario final

### Fase 6 (Semana 11): Despliegue
- Configuraci칩n de Vercel con CI/CD
- Despliegue a producci칩n
- Configuraci칩n de monitoreo
- Documentaci칩n final y capacitaci칩n

---

## 12. Consideraciones T칠cnicas

### 12.1 Performance
- C치lculos en tiempo real optimizados con memoizaci칩n
- Lazy loading de componentes y datos
- Caching de resultados de c치lculos con invalidaci칩n inteligente
- Paginaci칩n para listas grandes con virtualizaci칩n
- Optimizaci칩n de consultas de base de datos

### 12.2 Escalabilidad
- Arquitectura modular con separaci칩n clara de responsabilidades
- API stateless con rate limiting
- Base de datos optimizada con 칤ndices estrat칠gicos
- Microservicios para c치lculos complejos (futuro)
- Load balancing autom치tico en Vercel

### 12.3 Seguridad
- Validaci칩n de entrada en frontend y backend con Zod
- Sanitizaci칩n de datos y prevenci칩n de inyecci칩n SQL
- Control de acceso basado en roles (RBAC)
- Auditor칤a completa de cambios con no repudio
- Cifrado de datos sensibles en reposo y tr치nsito

---

## 13. Documentaci칩n Adicional

### 13.1 Referencias
- [Orientaci칩n SUNAT - C치lculo del Impuesto](https://orientacion.sunat.gob.pe/3071-02-calculo-del-impuesto)
- Documento de casos de prueba: `casos_de_prueba.md`
- Plantilla de f칩rmulas: `plantilla-formulas-sunat-5ta.md`
- [C칩digo Tributario del Per칰](https://www.gob.pe/institucion/sunat/normas-legales)
- [UIT vigente por a침o](https://www.gob.pe/institucion/sunat/informacion-institucional/uit)

### 13.2 Glosario
- **UIT**: Unidad Impositiva Tributaria
- **5ta Categor칤a**: Trabajadores dependientes
- **Retenci칩n**: Pago anticipado del impuesto a la renta
- **Gratificaci칩n**: Pago adicional por fiestas patrias y navidad
- **Bonificaci칩n**: Pago extraordinario por productividad
- **Utilidades**: Distribuci칩n de beneficios empresariales
- **Multi-empleador**: Trabajador con m치s de un empleador simult치neo
- **Constancia**: Documento oficial que certifica retenciones previas

---

## 14. Aprobaciones

- **Analista de Requisitos**: ___
- **Arquitecto de Software**: ___
- **L칤der de Proyecto**: ___
- **Cliente (SUNAT)**: ___
- **Auditor de Seguridad**: ___

**Fecha de Aprobaci칩n**: ___
**Versi칩n del Documento**: 2.0

---

## 15. Checklist de Cumplimiento 100%

### 15.1 Funcionalidades Core
- [ ] M칠todo proporcional y saldo corregidos y documentados
- [ ] Soporte multi-empleador con constancias certificadas
- [ ] Flujo de retenciones previas (empleador anterior)
- [ ] Manejo de ingreso/cese en meses distintos a enero
- [ ] Pol칤tica de redondeo 칰nica (2 decimales, half-up)

### 15.2 Arquitectura y Seguridad
- [ ] Tax tiers parametrizados por vigencia, no hard-codeados
- [ ] Cifrado de datos PII (DNI, nombre)
- [ ] RBAC implementado (RRHH, Auditor, Admin)
- [ ] Auditor칤a completa con logs de c치lculo
- [ ] Retenci칩n de datos conforme a pol칤tica

### 15.3 Testing y Validaci칩n
- [ ] Casos de prueba que cubran los 5 escenarios principales
- [ ] Edge cases y casos de stress probados
- [ ] Validaci칩n de f칩rmulas SUNAT verificada
- [ ] Testing de rendimiento con 1000 trabajadores
- [ ] Testing de seguridad y compliance

### 15.4 Documentaci칩n y Despliegue
- [ ] Documentaci칩n de usuario final completa
- [ ] Despliegue en Vercel con CI/CD
- [ ] Monitoreo y alertas configurados
- [ ] Backup y recuperaci칩n de desastres
- [ ] Capacitaci칩n de usuarios finales
